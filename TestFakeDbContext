using Microsoft.Data.Sqlite;
using Microsoft.EntityFrameworkCore;
using System;

namespace Tests
{
    // üî• Contexte d'exemple (remplace-le par le tien si n√©cessaire)
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options)
            : base(options)
        {
        }

        public DbSet<User> Users => Set<User>();
    }

    // üî• Une entit√© d'exemple (remplace-la ou ajoute les tiennes)
    public class User
    {
        public int Id { get; set; }
        public string Name { get; set; } = default!;
    }


    // ‚úÖ Factory pour cr√©er un vrai SQLite InMemory avec transactions support√©es
    public static class TestDbContextFactory
    {
        public static AppDbContext Create()
        {
            // 1. Cr√©e une connexion SQLite InMemory
            var connection = new SqliteConnection("Filename=:memory:");
            connection.Open(); // IMPORTANT : maintenir la connexion ouverte

            // 2. Options EF Core utilisant SQLite
            var options = new DbContextOptionsBuilder<AppDbContext>()
                .UseSqlite(connection)
                .EnableSensitiveDataLogging()
                .Options;

            // 3. Cr√©ation du contexte
            var context = new AppDbContext(options);

            // 4. Cr√©ation du sch√©ma en m√©moire
            // (√©quivalent √† EnsureCreated mais pour SQLite in-memory)
            context.Database.EnsureCreated();

            return context;
        }
    }
}