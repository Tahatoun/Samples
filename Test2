#!/bin/bash
# =====================================================================
# Script d'installation d'Oracle Instant Client (Basic + SDK + SQL*Plus)
# Compatible Ubuntu 20.04 / 22.04 / 24.04
# Auteur : ChatGPT (version professionnelle)
# =====================================================================

set -e  # Stoppe le script en cas d'erreur

echo "=== Installation d'Oracle Instant Client sur Ubuntu ==="

# --- 1️⃣ Préparation du système ---
sudo apt update -y
sudo apt install -y wget apt-transport-https libaio1 unzip

# --- 2️⃣ Téléchargement du package de configuration APT Oracle ---
echo ">>> Téléchargement du dépôt APT Oracle..."
wget https://download.oracle.com/otn_software/linux/instantclient/oracle-instantclient-apt-config_21.13.0.0.0-2_all.deb -O /tmp/oracle-apt-config.deb

# --- 3️⃣ Installation du dépôt Oracle ---
echo ">>> Installation du dépôt APT Oracle..."
sudo apt install -y /tmp/oracle-apt-config.deb

# --- 4️⃣ Mise à jour des dépôts ---
echo ">>> Mise à jour des dépôts APT..."
sudo apt update -y

# --- 5️⃣ Installation des composants Oracle ---
echo ">>> Installation du client Oracle (Basic + SDK + SQL*Plus)..."
sudo apt install -y oracle-instantclient-basic oracle-instantclient-sdk oracle-instantclient-sqlplus

# --- 6️⃣ Configuration de l'environnement ---
echo ">>> Configuration de l'environnement..."
INSTANT_PATH=$(ldconfig -p | grep "libclntsh.so" | head -n 1 | awk '{print $NF}' | xargs dirname)

if [ -z "$INSTANT_PATH" ]; then
    INSTANT_PATH="/usr/lib/oracle/21/client64/lib"
fi

PROFILE_FILE="$HOME/.bashrc"

grep -q "LD_LIBRARY_PATH" $PROFILE_FILE || echo "export LD_LIBRARY_PATH=$INSTANT_PATH:\$LD_LIBRARY_PATH" >> $PROFILE_FILE
grep -q "PATH" $PROFILE_FILE || echo "export PATH=\$PATH:$INSTANT_PATH" >> $PROFILE_FILE

source $PROFILE_FILE

# --- 7️⃣ Vérification ---
echo ">>> Vérification de l'installation..."
sqlplus -v || echo "⚠️  SQL*Plus non trouvé dans le PATH"
echo "Librairies Oracle disponibles dans : $INSTANT_PATH"

echo "✅ Installation terminée avec succès !"
echo "Pour activer les variables immédiatement, exécute : source ~/.bashrc"