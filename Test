-- =============================================
-- Fichier : Monitor_DirectPathLoad.sql
-- Description : Requêtes pour vérifier l'utilisation
--               du Direct Path Load pendant un Bulk Insert
-- =============================================

-- 1. Identifier ta session Oracle en cours (exemple avec TON_SCHEMA)
-- Remplace TON_SCHEMA par le nom de ton schéma Oracle

SELECT sid, serial#
FROM v$session
WHERE username = 'TON_SCHEMA';

-- Note : Note les valeurs SID et SERIAL# retournées pour la suite

-------------------------------------------------------------------------------

-- 2. Surveiller les opérations longues de type Direct Path Load en cours
-- Exécute cette requête pendant que ton Bulk Insert est en cours

SELECT opname, start_time, elapsed_seconds, sofar, totalwork, units, message
FROM v$session_longops
WHERE opname LIKE '%direct path load%'
  AND sofar != totalwork;

-------------------------------------------------------------------------------

-- 3. Activer le trace SQL sur ta session
-- Remplace <SID> et <SERIAL#> par les valeurs obtenues à l'étape 1

BEGIN
  DBMS_MONITOR.SESSION_TRACE_ENABLE(
    sid => <SID>,
    serial# => <SERIAL#>,
    waits => TRUE,
    binds => TRUE
  );
END;
/

-- Lancer ensuite ton Bulk Insert dans ton application ou SQL Developer

-------------------------------------------------------------------------------

-- 4. Une fois l'opération terminée, désactive le trace

BEGIN
  DBMS_MONITOR.SESSION_TRACE_DISABLE(
    sid => <SID>,
    serial# => <SERIAL#>
  );
END;
/

-------------------------------------------------------------------------------

-- 5. Analyse du fichier trace généré
-- Le fichier trace se trouve dans le répertoire USER_DUMP_DEST défini par Oracle
-- Utilise l’outil TKPROF pour analyser ce fichier
-- Exemple d’utilisation TKPROF (à lancer sur le serveur Oracle) :
-- tkprof <trace_file.trc> output=<output_file.txt> explain=TON_SCHEMA sys=no sort=exeela

-------------------------------------------------------------------------------

-- 6. Requête optionnelle pour consulter les plans SQL récents
-- Cela peut aider à voir si un Direct Path Insert a été utilisé

SELECT sql_id, operation, options, object_name
FROM dba_hist_sql_plan
WHERE operation LIKE '%INSERT%'
  AND options LIKE '%DIRECT%'
  AND object_owner = 'TON_SCHEMA'
ORDER BY last_active_time DESC;

-------------------------------------------------------------------------------

-- 7. Requête pour voir les sessions bloquées ou ressources occupées
-- Si tu rencontres des erreurs ORA-00054 (resource busy), cette requête peut aider

SELECT
  blocking_session,
  sid,
  serial#,
  wait_class,
  event,
  seconds_in_wait
FROM v$session
WHERE blocking_session IS NOT NULL;

-------------------------------------------------------------------------------

-- 8. Vérifier les contraintes qui pourraient empêcher le Direct Path Load
-- Liste des contraintes ENABLED sur une table

SELECT constraint_name, constraint_type, status
FROM all_constraints
WHERE table_name = 'NOM_DE_TA_TABLE'
  AND owner = 'TON_SCHEMA';

-------------------------------------------------------------------------------

-- Fin du fichier Monitor_DirectPathLoad.sql