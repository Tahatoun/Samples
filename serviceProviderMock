public class FakeKeyedServiceProvider : IServiceProvider, IKeyedServiceProvider
{
    private readonly Dictionary<(Type, object), object> _services = new();

    public void AddKeyed<T>(object key, T instance)
    {
        _services[(typeof(T), key)] = instance!;
    }

    public object? GetService(Type serviceType)
    {
        // Ne gère que GetRequiredService classique si besoin
        return _services
            .Where(s => s.Key.Item1 == serviceType)
            .Select(s => s.Value)
            .FirstOrDefault();
    }

    // IMPORTANT : méthode utilisée par GetRequiredKeyedService
    public object? GetKeyedService(Type serviceType, object? serviceKey)
    {
        return _services.TryGetValue((serviceType, serviceKey!), out var svc)
            ? svc
            : null;
    }
}